SimpliSafe DevOps Repo
======================
This project provides the tooling to build and manage development environments for most simplisafe web applications.  Currently we support virtualbox, parallels, and aws builds on OSX.

## Prerequisites

A number of dependencies are required for this tool to function.  Scripts to install all dependencies are provided for OSX.  Linux and Windows are not currently supported but patches are welcome!

### Virtualbox & Vagrant
The following applications are required.
* [vagrant](https://www.vagrantup.com/downloads.html)
* [virtualbox](https://www.virtualbox.org/wiki/Downloads)

These can be installed automatically on OSX with the following script.  ** Warning, this script installs and uses [homebrew](http://brew.sh/) **
```
   ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
   brew install caskroom/cask/brew-cask
   brew cask install vagrant
   brew cask install virtualbox
```

### Ruby Libraries
The following ruby gems are required globally:
* bundler
* rake

On OSX you can install them by running the following.
```
   sudo gem install bundler
   sudo gem install rake
```


Clone Github Repos
----------------
* Clone the repos you need by using the following script. To clone the SimpliSafe devops repo for example:
```
  git clone https://github.com/simplisafe/devops/ 
```

Initializing Vagrant Environment
--------------------------------
* Vagrant will likely require you to run the following script before you can run vagrant status:
```
  vagrant plugin install vagrant-aws
```
* 


Key Config Files
----------------

* ~/vagrant.d/Vagrantfile - These are global settings for vagrant.  This is a good place to store your AWS credentials so that they don't ever get accidentally get pushed to github or to built boxes.
* config/ss_overrides.yaml - This is the central config file for the project.  If you are looking to modify functionality, this is the place to start.  See config/ss_overrides.yaml.example for documentation of all of the options available to you.
* database/simplisafe_LIVE.sql - This is the sql file used to initialize your dev database.  As this is a large file, and it changes regularly, we do not keep it in git.  For now it is a manual process to get updates.  Talk to Kevin or Dan if you need an updated copy.

IAM AWS Credentials
-------------------

* Login to your AWS account
* Navigate to 'My Account' then 'Users' 
* Scroll down to Access Keys
* Click 'Create Access Key' then click 'Show credentials'
* Copy and paste the ID and Key into the 'AWS.md' file located inside your devops folder. 
  
Github ssh keys
---------------

Github requires 2 ssh keys in order to work. 
* The first comes from your ' devops/configs/ssh_keys/ ' directory.
* The second comes must be generated by running a script like:
```
  ssh-keygen -t rsa -b 4096 -C "your.email@example.com"
```
* It will ask you to confirm the location you would like it stored. Hit enter.


# Initialize the environment



Before using the dev environment, it is important to run through a number of initialization steps.

## Initialize environment variables

The initialization tasks are currently split between vagrant and rake.  In order to initialize your environment, you should run:
```
bundle install --path vendor/bundle
vagrant status
rake setup
```

In order to make sure the proper values get built, you will need to initialize your ss_overrides.yaml.  The important values to set are:

```
ss_dev_initials:
ss_aws_keypair:
ss_api::fqdn:
ss_drupal::fqdn:
ss_webapp::fqdn:
```

Any time these values you should rerun the setup commands from above.

To improve interoperability of your dev environment, you should consider getting your ssl certificates signed by the SimpliSafe internal CA.  Documentation on that is available in [DOCS/CERTS.md](DOCS/CERTS.md)

## Get data to initialize the database

Copies of the database are stored in the 'database' directory.  Each copy of the dev database should include the date of the backup it was generated from in the name when it is received.  The scripts, however, expect the file to be named 'simplisafe_LIVE.sql'.  Rather than rename the file to match what the scripts expect, we recommend creating a symlink that points simplisafe_LIVE.sql to the specific sql file you want to load.  This allows you to easily track which copy of the dev database you are on and also allows you to keep multiple versions allowing easy roll back in the event a new copy of the dev database breaks something.

## Deciding between normal & dev builds

In the vagrant environment, most machines can be deployed in two configurations.  The first pulls everything directly from github and is designed to match production as closely as possible.  The second enables shared filesystems between your host and the vm, allowing you to use local development tools while still seeing your changes live in the VM when working in virtualbox or parallels.  If in AWS, you will have to run a vagrant rsync before changes will be available on the VM.

In order to put a machine into dev mode, the `git_revision` must be set to local and `local_path` must be defined in the ss_overrides.yaml file.

For normal builds, the `local_path` is ignored and the `git_revision` can be any valid [git revision](https://www.kernel.org/pub/software/scm/git/docs/gitrevisions.html) as specified by the git documentation.

Examples:
````
# api in normal mode build against HEAD of test123 branch.
# webapp built in dev mode against source in '/Users/test/simplisafe_projects/web_app' directory.

ss_webapp::git_revision: local
ss_webapp::localpath:    /Users/test/simplisafe_projects/web_app
ss_api::git_revision:    test123
```

## Configuring shared filesystems

In the past, we had issues with the virtualbox and parallels shared filesystems and switch to NFS.  This should no longer be required.  If you are still running in this format, the old documentation for it can still be found [here](DOCS/NFS.md).


# Bringing up your environment

With your prerequisites installed and your configuration defined & built, you are ready to build your environment.

## Building puppet

*** locked build
librarian-puppet, the tool we use to manage our puppet libraries, uses lock files.  This ensures that we can reproduce a build exactly, even if our config files do not require a specific version or commit from github.  This is great for reproducing known working builds and is normally what you will want for the components you want to stay stable.  This build is kicked off by running:
```
rake build
```

*** updated build
This build will override the versions or commits specified in the lock file for the components specified.  This requires the locked build to be run first.  An update build only needs to be run when the branch for a project is not being updated in ss_overrides but newer code from the branch is required for that project than what was built previously. 
```
# api update to latest on branch test1
# drupal update to latest on branch test1
# everything else on the branch from the lock file
rake build
bundle exec librarian-puppet update simplisafe-ss_api
bundle exec librarian-puppet update simplisafe-ss_drupal
```

## Building your VMs
With your puppet modules now collected, you can start your VMs with `vagrant up`.
2. *Building:* If the box does not already exist:
  1.  Download the 'base box' for the vm if you do not have it cached.  This is a minimal install of the os prepared to automatically allow vagrant ssh access.
  2. Create the VM in your hypervisor from the base box.
4. *Booting:* If the box is not already running  
  1. Modify the VM based on your config.  
  2. Boot the VM.
6. *Provisioning:* If the box has not already been provisioned  
  1.  Set up the second hard drive if required (mysql)  
  2.  Run puppet  

Here's a list of common commands with arguments you might want to use.

| Command | Puppet Stage | Building Stage | Booting Stage | Provisioning Stage |
|--------|-------|--------|-------|--------|
| `vagrant up` | Always | Optional | Optional | Optional |
| `vagrant up --provision | Always | Optional | Optional | Always |
| `vagrant reload` | Always | Never | Always | Optional |
| `vagrant reload --provision` | Always | Never | Always | Always |
| `vagrant provision` | Always | Never | Never | Always |

Optional stages can be skipped if vagrant determines they were already run.

Vagrant is flexible, allowing you to run any of the above commands targeting a subset of boxes.  

Here are a few common events to hopefully illustrate the usage of some of the commands.

| Issue | Dev environment doesn't exist | Dev env built but halted | Dev env up and running |
|-------|------|----------|----------|--------|
| Due to a vagrant bug, the ip addresses of all of your VMs appear to have changes.  You want to make vagrant reset your environment. | `vagrant up` | `vagrant up` | `vagrant reload` |
| You increased the memory and cpu on webapp in the Vagrant file and want to apply it.  | `vagrant up webapp` | `vagrant up webapp` | `vagrant reload webapp` |
| You built your dev environment last week against master and want to see the latest stable build out of curiosity. | `vagrant up` | `vagrant up --provision` | `vagrant provision` | 
| While testing, a bug was found in API and committed to the test123 branch.  You want the change without having to do a complete rebuild. | `vagrant up api` | `vagrant up --provision api` | `vagrant provision api` |
| You've made a change to the webapp code and want to see it in the VM. | Open your browser | Open your browser | Open your browser | 
| You've changed the subnet your VMs are on.  You need to update the IPs on the VMs and the configs for each service. | `vagrant up` | `vagrant up --provision` | `vagrant reload --provision` | 
| You've gotten an updated copy of the database and want to load it. | `vagrant up` | `vagrant destroy && vagrant up` | `vagrant destroy && vagrant up` | 
| You want to watch youtube videos but your battery life seems to be terrible. | Go watch videos | Go watch videos | `vagrant halt` | 
